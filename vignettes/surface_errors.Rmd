---
title: "Surface Errors"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.path = "./vignettes/figures/")
require(ggplot2)
bbb <- read.csv(file = "C:/Users/seanr/OneDrive/afsc/Light data processing/testing_space/data/LightData/Data/year_06/ebs/v_134/deck1_0490940.csv", header = F)
haul_time_position <- readRDS("C:/Users/seanr/OneDrive/afsc/Light data processing/testing_space/data/haul_time_position.rds")
names(bbb) <- c("date", "time", "cdepth", "temp", "clight")
```

## Problem

Some problems were detected after examination of the relationship between surface-incident clear-sky PAR estimated by global irradiance model and light measurements from the deck-mounted archival tag. Here, I fix the problem for one vessel/cruise. This is a somewhat convoluted example because the time offset error was already recorded in Stan's notes for this vessel/cruise. However, it was a slightly more "involved" fix than for other years.

Two possible explanations for discrepancies are:
* Measurement error due to obstruction of the photoelectric cell (e.g. gull-induced biofouling)
* Time zone mismatch between archival tag and "survey time."

The scatterplot seemed to suggest the latter explanation since the full range of light measurments seemed to occur. However, it's possible that both errors occurred.

#### Obstruction?
If the photoelectric cell was obstructed, diel peaks in light measurements would be expected to drop precipitously. Let's plot the raw tag data:

```{r}
head(bbb)
bbb$datetime <- paste(bbb$date, bbb$time)
bbb$datetime <- as.POSIXct(bbb$datetime, format = "%m/%d/%Y %H:%M:%S", tz = "America/Anchorage")
ggplot(data = bbb, aes(x = datetime, y = clight)) + geom_path()

```

Looks pretty normal-- no evidence that the tag was obstructed.

#### Wrong time?

Next, I checked to see if the timestamps were off, by plotting the sunrise time for the first haul of the day.
```{r}
require(fishmethods)
require(lubridate)


# Vessel/cruise of interest
ccc <- subset(haul_time_position, vessel == 134 & cruise == 200601)

# Only the first haul of the day
ccc <- subset(ccc, haul %in% aggregate(haul ~ yday(ccc$start_time), data = ccc, FUN = min)[,2])

# Calculate sunrise time
ccc <- cbind(ccc,
       fishmethods::astrocalc4r(day = day(ccc$start_time),
                  month = month(ccc$start_time),
                  year = year(ccc$start_time),
                  hour = hour(ccc$start_time) + minute(ccc$start_time)/60,
                  timezone = rep(-8, nrow(ccc)),
                  lat = ccc$start_latitude,
                  lon = ccc$start_longitude,
                  seaorland = "maritime"))

# Convert sunrise time to POSIXct
ccc$sunrise2 <- as.POSIXct(paste(date(ccc$start_time), " ", floor(ccc$sunrise), ":", floor(ccc$sunrise%%1 * 60), ":", floor((ccc$sunrise%%1 * 60)%%1*60), sep = ""), tz = "America/Anchorage")

head(ccc)

# Plot sunrise times over light meaurements.
ggplot() + geom_path(data = bbb, aes(x = datetime, y = clight)) +
  geom_vline(data = ccc, aes(xintercept = sunrise2), col = "red", linetype = 2)

```

Sunrises times from the first half of the survey look consistent with the time stamps. Sunrise times from the second half look like they occurred in the middle of the day:
```{r}
ggplot() + geom_path(data = subset(bbb, month(datetime) == 7 & day(datetime) < 15), aes(x = datetime, y = clight)) +
  geom_vline(data = subset(ccc, month(sunrise2) == 7 & day(sunrise2) < 15), aes(xintercept = sunrise2), col = "red", linetype = 2)
```

After some trial and error, it looks like the archival tag times were off by 12 hours. Here, the archival tag timestamps are shifted by 12 hours (12 * 3600):
```{r}
ggplot() + geom_path(data = subset(bbb, month(datetime) >= 7 & day(datetime) > 5), aes(x = datetime - 12 * 3600, y = clight)) +
  geom_vline(data = subset(ccc, month(sunrise2) >= 7 & day(sunrise2) > 5), aes(xintercept = sunrise2), col = "red", linetype = 2)
```


## Adding the correction

Now that I know how to fix the problem, I add a conditional correction to time_adjustment.R:
```{text}
  if(cast.data$vessel[1] == 134 & cast.data$cruise[1] == 200601) {
    print("Correcting 134-201101")
    light.data$ctime[lubridate::month(light.data$ctime) >=7 & lubridate::day(light.data$ctime) > 8] <- light.data$ctime[lubridate::month(light.data$ctime) >=7 & lubridate::day(light.data$ctime) > 8] - 3600*12 # Time off by 1 hour
  }
```
